# 4174 포트 문제 해결 방안 (추가)

## 문제 현상

- `<!--app-html-->` 플레이스홀더가 치환되지 않음
- 기존 해결 방안들을 모두 시도했지만 해결되지 않음

## 새로운 해결 방안

### 방안 1: 상세 디버깅 로그 추가 ✅

**목적**: 각 단계에서 무엇이 문제인지 정확히 파악

**추가된 로그:**
1. 요청 정보 로그
   - `req.method`, `req.originalUrl`, `req.url`, `req.path`, `base`, `prod`
2. URL 구성 로그
   - 프로덕션/개발 모드별 URL 구성 과정
3. render 함수 호출 전후 로그
   - render 함수 실행 여부
   - 반환값 존재 여부
   - html 길이 및 미리보기
4. 템플릿 치환 로그
   - 템플릿 길이
   - 플레이스홀더 존재 여부
   - 치환 완료 여부

**위치**: `packages/vanilla/server.js` (211-280줄)

### 방안 2: URL 처리 로직 수정 ✅

**문제**: 프로덕션 모드에서 `req.originalUrl`을 그대로 사용하면 base 경로가 중복되거나 잘못 처리될 수 있음

**해결**:
```javascript
let url;
if (prod) {
  // 프로덕션: req.path는 base 경로가 제거된 경로이므로, base 경로를 다시 추가
  const pathWithoutBase = req.path || "/";
  url = base.replace(/\/$/, "") + pathWithoutBase;
} else {
  // 개발: 원본 URL 사용
  url = req.originalUrl?.split("?")[0] || req.url.split("?")[0];
}
```

**위치**: `packages/vanilla/server.js` (226-237줄)

### 방안 3: 에러 발생 시에도 기본 HTML 반환 ✅

**문제**: 에러가 발생하면 플레이스홀더가 치환되지 않은 상태로 응답이 전송될 수 있음

**해결**:
- 에러 발생 시에도 템플릿의 플레이스홀더를 치환하여 응답
- 에러 메시지를 HTML로 렌더링하여 표시
- 플레이스홀더가 없으면 강제로 삽입

**위치**: `packages/vanilla/server.js` (290-340줄)

### 방안 4: render 함수 초기화 확인 ✅

**추가**: render 함수가 초기화되었는지 확인하는 로직 추가

```javascript
if (!render) {
  throw new Error("render 함수가 초기화되지 않았습니다.");
}
```

**위치**: `packages/vanilla/server.js` (243-245줄)

### 방안 5: appHtml 기본값 개선 ✅

**이전**: 빈 문자열이면 `<div id="root"></div>` 사용
**개선**: 빈 문자열이면 경고 메시지 포함한 HTML 반환

```javascript
const finalAppHtml = appHtml && appHtml.trim().length > 0 
  ? appHtml 
  : '<div id="root"><div class="p-4 text-yellow-600">⚠️ SSR 렌더링 결과가 비어있습니다.</div></div>';
```

**위치**: `packages/vanilla/server.js` (260-263줄)

## 디버깅 방법

### 1. 서버 실행 및 로그 확인

```bash
# 프로덕션 서버 실행
pnpm -F @hanghae-plus/shopping-vanilla preview:ssr
```

### 2. 브라우저에서 접속

```
http://localhost:4174/front_7th_chapter4-1/vanilla/
```

### 3. 서버 콘솔 로그 확인

다음 로그들을 순서대로 확인:

1. **요청 받음 로그**
   ```
   [SSR Debug 4174] 요청 받음: { method, originalUrl, url, path, base, prod }
   ```
   - `path`가 올바른지 확인
   - `base`가 올바른지 확인

2. **URL 구성 로그**
   ```
   [SSR Debug 4174] 프로덕션 URL 구성: { pathWithoutBase, base, url }
   ```
   - 최종 `url`이 올바른지 확인

3. **render 함수 호출 로그**
   ```
   [SSR Debug 4174] render 함수 호출 시작: { url, query }
   ```

4. **render 함수 결과 로그**
   ```
   [SSR Debug 4174] render 함수 결과: { hasResult, hasHtml, htmlLength, htmlPreview, ... }
   ```
   - `hasResult`: render 함수가 결과를 반환했는지
   - `hasHtml`: html이 있는지
   - `htmlLength`: html 길이 (0이면 문제)
   - `htmlPreview`: html 미리보기

5. **최종 appHtml 로그**
   ```
   [SSR Debug 4174] 최종 appHtml: { length, preview }
   ```
   - `length`가 0이면 문제

6. **템플릿 확인 로그**
   ```
   [SSR Debug 4174] 템플릿 확인: { templateLength, hasAppHtml, hasAppHead, hasAppTitle }
   ```
   - `hasAppHtml`이 `false`면 템플릿 문제

7. **치환 완료 로그**
   ```
   [SSR Debug 4174] 치환 완료: { htmlLength, stillHasPlaceholder }
   ```
   - `stillHasPlaceholder`가 `true`면 치환 실패

### 4. 에러 로그 확인

에러가 발생하면:
```
[SSR Error 4174] 렌더링 오류: ...
[SSR Error 4174] 에러 스택: ...
```

## 문제별 해결 방법

### 문제 1: render 함수가 결과를 반환하지 않음

**로그**: `hasResult: false`

**원인**:
- render 함수가 undefined 반환
- render 함수에서 에러 발생

**해결**:
- `main-server.js`의 render 함수 확인
- 에러가 발생하는지 확인

### 문제 2: html이 비어있음

**로그**: `htmlLength: 0`

**원인**:
- 라우트 매칭 실패
- 데이터 프리페칭 실패
- 렌더링 로직 실행 안 됨

**해결**:
- `main-server.js`의 라우트 매칭 로직 확인
- 데이터 프리페칭 로직 확인
- `main-server.js`에 디버깅 로그 추가

### 문제 3: 템플릿에 플레이스홀더가 없음

**로그**: `hasAppHtml: false`

**원인**:
- 템플릿 파일 경로 문제
- 템플릿 파일 내용 문제

**해결**:
- `packages/vanilla/index.html` 파일 확인
- `templatePath` 확인

### 문제 4: 치환이 실패함

**로그**: `stillHasPlaceholder: true`

**원인**:
- `replace` 메서드가 실행되지 않음
- 플레이스홀더 형식이 다름

**해결**:
- `replace` 메서드가 실행되는지 확인
- 플레이스홀더 형식 확인 (`<!--app-html-->` 정확히 일치하는지)

## 추가 확인 사항

### 1. 빌드 확인

```bash
# 서버 빌드 확인
ls -la packages/vanilla/dist/vanilla-ssr/main-server.js

# 클라이언트 빌드 확인
ls -la packages/vanilla/dist/vanilla/
```

### 2. 템플릿 파일 확인

```bash
# 템플릿 파일 확인
cat packages/vanilla/index.html | grep "app-html"
```

### 3. 프로덕션 모드 확인

```bash
# 환경 변수 확인
echo $NODE_ENV  # 또는 Windows: echo %NODE_ENV%
```

## 다음 단계

1. 서버 실행 후 로그 확인
2. 각 로그 단계별로 문제 파악
3. 문제에 맞는 해결 방법 적용
4. 재시도

## 참고

- 기존 해결 방안: `.cursor/docs/4174문제해결방안.md`
- 개발/프로덕션 서버 차이점: `.cursor/docs/개발프로덕션서버차이점.md`

